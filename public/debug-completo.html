<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Completo - Navegador</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1a1a1a;
            color: #00ff00;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .teste { 
            margin: 10px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            background: #2a2a2a;
            border-radius: 5px;
        }
        .sucesso { background-color: #0d4f0d; border-color: #28a745; }
        .erro { background-color: #4f0d0d; border-color: #dc3545; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-family: inherit;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #000; 
            padding: 10px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-size: 12px;
            border: 1px solid #333;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
        }
        .info-box {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        h1, h2 { color: #00ff00; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG COMPLETO - NAVEGADOR</h1>
        <p>Teste para identificar o problema de "Failed to fetch" no navegador</p>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è Informa√ß√µes do Navegador:</h3>
            <div id="browser-info"></div>
        </div>
        
        <div class="info-box">
            <h3>üåê Informa√ß√µes da P√°gina:</h3>
            <div id="page-info"></div>
        </div>

        <div class="teste">
            <h3>1Ô∏è‚É£ Teste: Informa√ß√µes do Ambiente</h3>
            <button onclick="mostrarInfoAmbiente()">Mostrar Informa√ß√µes</button>
            <div id="info-ambiente" class="log"></div>
        </div>
        
        <div class="teste">
            <h3>2Ô∏è‚É£ Teste: Verificar Mixed Content (HTTP/HTTPS)</h3>
            <button onclick="verificarMixedContent()">Verificar Mixed Content</button>
            <div id="mixed-content" class="log"></div>
        </div>
        
        <div class="teste">
            <h3>3Ô∏è‚É£ Teste: Conex√£o com Backend (Sem CORS)</h3>
            <button onclick="testarConexaoSimples()">Testar Conex√£o Simples</button>
            <div id="conexao-simples" class="log"></div>
        </div>
        
        <div class="teste">
            <h3>4Ô∏è‚É£ Teste: Conex√£o com Backend (Com CORS)</h3>
            <button onclick="testarConexaoCors()">Testar Conex√£o CORS</button>
            <div id="conexao-cors" class="log"></div>
        </div>
        
        <div class="teste">
            <h3>5Ô∏è‚É£ Teste: XMLHttpRequest (Alternativa ao fetch)</h3>
            <button onclick="testarXMLHttpRequest()">Testar XMLHttpRequest</button>
            <div id="xmlhttp-test" class="log"></div>
        </div>
        
        <div class="teste">
            <h3>6Ô∏è‚É£ Teste: Verificar Extens√µes/Ad Blockers</h3>
            <button onclick="verificarAdBlockers()">Verificar Bloqueios</button>
            <div id="adblock-test" class="log"></div>
        </div>

        <div class="teste">
            <h3>7Ô∏è‚É£ Teste: Todos os Testes Autom√°ticos</h3>
            <button onclick="executarTodosTestes()">Executar Todos os Testes</button>
            <div id="todos-testes" class="log"></div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para logar mensagens
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        // 1Ô∏è‚É£ Mostrar informa√ß√µes do ambiente
        function mostrarInfoAmbiente() {
            const log = document.getElementById('info-ambiente');
            log.innerHTML = '';
            
            log('info-ambiente', 'üì± User Agent: ' + navigator.userAgent);
            log('info-ambiente', 'üîí Protocolo da P√°gina: ' + window.location.protocol);
            log('info-ambiente', 'üåê Host da P√°gina: ' + window.location.host);
            log('info-ambiente', 'üìç Porta da P√°gina: ' + window.location.port);
            log('info-ambiente', 'üîÑ HTTPS: ' + (window.location.protocol === 'https:'));
            log('info-ambiente', 'üéØ Origin: ' + window.location.origin);
            log('info-ambiente', 'üîó Referrer: ' + document.referrer);
            
            // Testar se estamos em ambiente de desenvolvimento
            const isLocalhost = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1' ||
                              window.location.hostname.includes('192.168.');
            log('info-ambiente', 'üè† Ambiente Local: ' + isLocalhost);
        }

        // 2Ô∏è‚É£ Verificar Mixed Content
        function verificarMixedContent() {
            const log = document.getElementById('mixed-content');
            log.innerHTML = '';
            
            const pageProtocol = window.location.protocol;
            const apiProtocol = 'http:'; // Nossa API est√° em HTTP
            
            log('mixed-content', 'üîí Protocolo da P√°gina: ' + pageProtocol);
            log('mixed-content', 'üåê Protocolo da API: ' + apiProtocol);
            
            if (pageProtocol === 'https:' && apiProtocol === 'http:') {
                log('mixed-content', 'ÔøΩÔ∏è MIXED CONTENT DETECTADO! HTTPS ‚Üí HTTP', 'error');
                log('mixed-content', 'üîí O navegador pode estar bloqueando por seguran√ßa', 'error');
                log('mixed-content', 'üí° Solu√ß√£o: Use HTTPS para a API ou HTTP para a p√°gina', 'warning');
            } else {
                log('mixed-content', '‚úÖ Sem problema de Mixed Content', 'success');
            }
        }

        // 3Ô∏è‚É£ Testar conex√£o simples (sem headers complexos)
        async function testarConexaoSimples() {
            const log = document.getElementById('conexao-simples');
            log.innerHTML = '';
            
            try {
                log('conexao-simples', 'üîÑ Testando conex√£o simples com http://localhost:3001/nfe/teste...');
                
                const response = await fetch('http://localhost:3001/nfe/teste', {
                    method: 'GET',
                    mode: 'no-cors', // Desabilitar CORS
                    cache: 'no-cache'
                });
                
                log('conexao-simples', 'üì° Status (opaco): ' + response.status, 'warning');
                log('conexao-simples', 'üì° Tipo de resposta: ' + response.type, 'warning');
                log('conexao-simples', '‚úÖ Conex√£o estabelecida (sem CORS)', 'success');
                
            } catch (error) {
                log('conexao-simples', '‚ùå Erro: ' + error.message, 'error');
                log('conexao-simples', 'üî• Tipo: ' + error.constructor.name, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('conexao-simples', '‚ùì Poss√≠veis causas:', 'error');
                    log('conexao-simples', '   - Servidor offline', 'error');
                    log('conexao-simples', '   - Porta bloqueada', 'error');
                    log('conexao-simples', '   - Firewall/Antiv√≠rus', 'error');
                    log('conexao-simples', '   - Mixed Content (HTTPS‚ÜíHTTP)', 'error');
                }
            }
        }

        // 4Ô∏è‚É£ Testar conex√£o com CORS
        async function testarConexaoCors() {
            const log = document.getElementById('conexao-cors');
            log.innerHTML = '';
            
            try {
                log('conexao-cors', 'üîÑ Testando conex√£o com CORS...');
                
                const response = await fetch('http://localhost:3001/nfe/teste', {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                log('conexao-cors', 'üì° Status: ' + response.status);
                log('conexao-cors', 'üì° Headers: ' + JSON.stringify(Object.fromEntries(response.headers.entries())));
                
                const data = await response.json();
                log('conexao-cors', '‚úÖ Dados: ' + JSON.stringify(data), 'success');
                
            } catch (error) {
                log('conexao-cors', '‚ùå Erro CORS: ' + error.message, 'error');
                log('conexao-cors', 'üî• Tipo: ' + error.constructor.name, 'error');
                
                if (error.message.includes('CORS')) {
                    log('conexao-cors', 'üîí CORS bloqueado!', 'error');
                    log('conexao-cors', 'üí° Verifique os headers do servidor', 'warning');
                }
            }
        }

        // 5Ô∏è‚É£ Testar XMLHttpRequest
        function testarXMLHttpRequest() {
            const log = document.getElementById('xmlhttp-test');
            log.innerHTML = '';
            
            try {
                log('xmlhttp-test', 'üîÑ Testando XMLHttpRequest...');
                
                const xhr = new XMLHttpRequest();
                
                xhr.onreadystatechange = function() {
                    log('xmlhttp-test', 'üì° ReadyState: ' + xhr.readyState);
                    
                    if (xhr.readyState === 4) {
                        log('xmlhttp-test', 'üì° Status: ' + xhr.status);
                        log('xmlhttp-test', 'üì° Status Text: ' + xhr.statusText);
                        log('xmlhttp-test', 'üì° Response Headers: ' + xhr.getAllResponseHeaders());
                        
                        if (xhr.status === 200) {
                            try {
                                const data = JSON.parse(xhr.responseText);
                                log('xmlhttp-test', '‚úÖ Dados: ' + JSON.stringify(data), 'success');
                            } catch (e) {
                                log('xmlhttp-test', '‚úÖ Resposta: ' + xhr.responseText, 'success');
                            }
                        } else {
                            log('xmlhttp-test', '‚ùå Erro HTTP: ' + xhr.status, 'error');
                        }
                    }
                };
                
                xhr.onerror = function() {
                    log('xmlhttp-test', '‚ùå XMLHttpRequest Error', 'error');
                    log('xmlhttp-test', 'üî• Network Error ou CORS bloqueado', 'error');
                };
                
                xhr.open('GET', 'http://localhost:3001/nfe/teste', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send();
                
                log('xmlhttp-test', 'üì§ Requisi√ß√£o enviada...');
                
            } catch (error) {
                log('xmlhttp-test', '‚ùå Erro: ' + error.message, 'error');
            }
        }

        // 6Ô∏è‚É£ Verificar Ad Blockers
        function verificarAdBlockers() {
            const log = document.getElementById('adblock-test');
            log.innerHTML = '';
            
            log('adblock-test', 'üîç Verificando bloqueios...');
            
            // Testar se o navegador bloqueia requisi√ß√µes para localhost
            setTimeout(() => {
                log('adblock-test', 'üîÑ Testando requisi√ß√£o para localhost:3001...');
                
                fetch('http://localhost:3001/nfe/teste', {
                    method: 'HEAD',
                    mode: 'no-cors'
                }).then(() => {
                    log('adblock-test', '‚úÖ Requisi√ß√£o permitida', 'success');
                }).catch(() => {
                    log('adblock-test', '‚ùå Requisi√ß√£o bloqueada', 'error');
                    log('adblock-test', 'üí° Verifique: Ad Blocker, Antiv√≠rus, Firewall', 'warning');
                });
                
            }, 1000);
        }

        // 7Ô∏è‚É£ Executar todos os testes
        async function executarTodosTestes() {
            const log = document.getElementById('todos-testes');
            log.innerHTML = '';
            
            log('todos-testes', 'üöÄ Iniciando testes autom√°ticos...', 'warning');
            
            mostrarInfoAmbiente();
            await delay(1000);
            
            verificarMixedContent();
            await delay(1000);
            
            await testarConexaoSimples();
            await delay(2000);
            
            await testarConexaoCors();
            await delay(2000);
            
            testarXMLHttpRequest();
            await delay(2000);
            
            verificarAdBlockers();
            await delay(2000);
            
            log('todos-testes', '‚úÖ Testes conclu√≠dos! Analise os resultados acima.', 'success');
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Executar informa√ß√µes iniciais ao carregar
        window.addEventListener('load', () => {
            console.log('üîç P√°gina de debug carregada');
            
            // Mostrar informa√ß√µes do navegador
            document.getElementById('browser-info').innerHTML = `
                <p><strong>Navegador:</strong> ${navigator.userAgent}</p>
                <p><strong>Plataforma:</strong> ${navigator.platform}</p>
                <p><strong>Idioma:</strong> ${navigator.language}</p>
                <p><strong>Cookies:</strong> ${navigator.cookieEnabled ? 'Ativados' : 'Desativados'}</p>
            `;
            
            // Mostrar informa√ß√µes da p√°gina
            document.getElementById('page-info').innerHTML = `
                <p><strong>URL:</strong> ${window.location.href}</p>
                <p><strong>Protocolo:</strong> ${window.location.protocol}</p>
                <p><strong>Host:</strong> ${window.location.host}</p>
                <p><strong>Origin:</strong> ${window.location.origin}</p>
            `;
        });
    </script>
</body>
</html>